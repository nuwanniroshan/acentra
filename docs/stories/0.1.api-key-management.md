# Story 0.1: API Key Authentication Management

## Status
- [x] Draft
- [x] Approved
- [x] InProgress
- [x] Review
- [x] Done

## Story
**As a** Workspace Administrator,
**I want** to securely generate, view (once), and revoke API Keys for my tenant,
**so that** I can authorize third-party services to access our recruitment data without compromising individual user credentials.

## Acceptance Criteria

### Functional Requirements
1. **Generation:** An authenticated user with the `ADMIN` role can generate a new API Key within the workspace settings.
2. **Secret Disclosure:** Upon generation, the full API key secret MUST be displayed to the user exactly once. A warning must be shown that it cannot be retrieved again.
3. **Management Table:** The Admin can view a list of active API keys for their workspace, showing the Key Name, Created Date, Last Used Date, and a masked version of the ID (e.g., `ac_..._f9a2`).
4. **Revocation:** The Admin can revoke (delete) any API key, which must immediately invalidate the key across all backend services.
5. **Secure Storage:** API Key secrets must be stored using a one-way secure hash (e.g., Argon2 or SHA-256 with salt) in the database. The system must never store the plain-text secret.

### Integration Requirements
6. **Authentication Middleware:** A new authentication strategy/middleware in `acentra-backend` must intercept requests containing the `X-API-KEY` header.
7. **Multi-Tenant Isolation:** Validating an API key must correctly resolve and set the `tenantId` in the request context, ensuring the caller can only access data belonging to that specific workspace.
8. **Context Compatibility:** The API key authentication must inject a "Service User" or "System" identity into the request context so existing controllers can handle ownership logic without modification.
9. **No Regression:** The existing JWT-based authentication flow for web users must remain fully functional and take precedence.

### Quality Requirements
10. **Test Coverage:** The new middleware and storage service must have 100% unit test coverage for success, failure (invalid key), and unauthorized (missing key) scenarios.
11. **Negative Testing:** Revoked keys must return a `401 Unauthorized` response.

## Tasks / Subtasks

### Backend (`acentra-backend`)
- [x] **Data Model:** Create `ApiKey` entity in TypeORM (AC: #1, #2, #4, #5)
    - [x] Fields: `id`, `hashedKey`, `name`, `tenantId`, `maskedKey`, `lastUsedAt`, `createdAt`, `revokedAt`.
    - [x] Create Database Migration.
- [x] **Service Layer:** Implement `ApiKeyService` (AC: #1, #2, #4, #5)
    - [x] `generateKey(name, tenantId)`: Returns `{ plainTextKey, entity }`.
    - [x] `validateKey(plainTextKey)`: Finds and validates against hashed storage.
    - [x] `revokeKey(id)`: Marks key as revoked.
- [x] **Middleware:** Create `apiKeyAuthMiddleware` (AC: #6, #7, #8, #9)
    - [x] Extract `X-API-KEY` from headers.
    - [x] Validate and inject `tenantId` and `USER_ROLE.SYSTEM` into req context.
- [x] **API Controller:** Create `ApiKeyController` (AC: #1, #3, #4)
    - [x] `POST /settings/api-keys`: Request new key.
    - [x] `GET /settings/api-keys`: List keys for current tenant.
    - [x] `DELETE /settings/api-keys/:id`: Revoke access.

### Frontend (`acentra-frontend`)
- [x] **Settings UI:** Add "API Keys" tab to Workspace Settings (AC: #3)
- [x] **Action Flow:** Implement "Generate New Key" Modal (AC: #1, #2)
    - [x] "Secret Reveal" UI with confirmation.
- [x] **Action Flow:** Implement Revocation (AC: #4)

## Dev Notes
- **Security Pattern:** Use the "Service Account" pattern. Mapping API keys to a "SYSTEM" role ensures logs distinguish automated actions from human ones.
- **Database:** Ensure `@Index` is applied to the `hashedKey` field for performance.
- **Key Format:** Prefix keys with `ac_` (e.g., `ac_32charactersecret`).
- **Pattern Reference:** Check `apps/auth-backend/src/middleware/tenantMiddleware.ts` for context injection patterns.

## Testing Standards
- **Backend:** `apps/acentra-backend/src/middleware/__tests__/apiKeyAuth.middleware.spec.ts`
- **Frontend:** `apps/acentra-frontend/src/components/settings/__tests__/ApiKeyManager.spec.tsx`
- **Mocking:** Mock TypeORM for middleware tests.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-22 | 0.1 | Initial Story Creation | PM (John) |
